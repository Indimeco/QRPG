-- INITIATIVE CARD BRAIN

function onload()
    initiativeCard = getObjectFromGUID('bbf673')
    AUXInitiativeCardGUID = 'c82dbf'
    activeInitiativeZone = getObjectFromGUID('0fd547')
    locationOfScrollingFunctions = 'aad6e8'

    initiativeCard.setTable('pos',{0,0.8,-0.72})
    initiativeCard.setTable('rot',{0,180,0})
    callLuaFunctionInOtherScriptWithParams(Global,'addButton',{initiativeCard.getGUID(),450,170,57,'Initiative Roll','callRoutine',self})

    initiativeCard.setTable('pos',{0,0.8,0.72})
    initiativeCard.setTable('rot',{0,180,0})
    callLuaFunctionInOtherScriptWithParams(Global,'addButton',{initiativeCard.getGUID(),450,170,57,'Next Turn','nextTurn',self})

    initiativeCard.setVar('AUXGUID',AUXInitiativeCardGUID)
    initiativeCard.setTable('pos',{-0.45,3.5,0.4})
    initiativeCard.setTable('rot',{0,180,0})
    callLuaFunctionInOtherScriptWithParams(Global,'addButton',{initiativeCard.getGUID(), 50,75,50,'^','scrollUp',getObjectFromGUID(locationOfScrollingFunctions)})

    initiativeCard.setTable('pos',{-0.45,3.5,-0.4})
    initiativeCard.setTable('rot',{0,0,0})
    callLuaFunctionInOtherScriptWithParams(Global,'addButton',{initiativeCard.getGUID(), 50,75,50,'^','scrollDown',getObjectFromGUID(locationOfScrollingFunctions)})

    labels = {'Initiative Roll','Cancel'}
    x = 0

    playerInitiatives = {{'Purple Player', 1}, {'Blue Player', 10}, {'Green Player', 5}, {'Yellow Player', 6}, {'Orange Player', 2}, {'Red Player',1}}
end

function callRoutine()
    startLuaCoroutine(getObjectFromGUID('ROLL'),'initiativeCall')
    x = 1 - x
    params = initiativeCard.getButtons()
    params[1]['label'] = labels[x+1]
    params[1]['click_function'] = 'cancelInit'
    initiativeCard.editButton(params[1])
    getInitiative()
end

function cancelInit()
    callLuaFunctionInOtherScript(getObjectFromGUID('ROLL'), 'cleanupInitiative')
    x = 1 - x
    params = initiativeCard.getButtons()
    params[1]['label'] = labels[x+1]
    params[1]['click_function'] = 'callRoutine'
    initiativeCard.editButton(params[1])
end

function getInitiative()
    initiativeCard.setDescription('')
    local name
    initiatives = {}
    for i,v in pairs (playerInitiatives) do
        table.insert(initiatives, playerInitiatives[i])
    end
    local zoneObjs = activeInitiativeZone.getObjects()
    for i,v in pairs(zoneObjs) do
        if zoneObjs[i].getVar('cardname') ~= nil and zoneObjs[i].getRotation()[2] < 180 then
            if zoneObjs[i].getName() ~= '' then
                name = zoneObjs[i].getName()
            else name = zoneObjs[i].getVar('cardname')
            end
            table.insert(initiatives, {name, math.random(20)})
        end
    end
    initiatives = table.sort(initiatives, compare)
    initiativeCard.setName('Up Next is '..initiatives[1][1]..': '..initiatives[1][2])
    for i,v in pairs(initiatives) do
        if i > 1 then
            initiativeCard.setDescription(initiativeCard.getDescription()..initiatives[i][1]..': '..initiatives[i][2]..'\n')
        end
    end
end

function compare(a,b)
  return a[2] < b[2]
end

function nextTurn()
    local tempDesc
    if getObjectFromGUID(AUXInitiativeCardGUID).getDescription() ~= '' and initiativeCard.getDescription() ~= '' then
        tempDesc = getObjectFromGUID(AUXInitiativeCardGUID).getDescription()..'\n'..initiativeCard.getDescription()
    else
        tempDesc = getObjectFromGUID(AUXInitiativeCardGUID).getDescription()..initiativeCard.getDescription()
    end

    local i = string.find(tempDesc,'\n',1)
    print(i)
    getObjectFromGUID(AUXInitiativeCardGUID).setDescription('')
    initiativeCard.setDescription(string.sub(tempDesc,i+1)..string.sub(initiativeCard.getName(),12)..'\n')
    initiativeCard.setName('Up Next is '..string.sub(tempDesc,1,i-1))
end
