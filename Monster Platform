-- GLOBAL

function onObjectEnterScriptingZone(zone, enter_object)
    if zone.getGUID() == '5b0f80' then
        if enter_object.getVar('cardname') ~= nil then
            if enter_object.getVar('value1') == nil then
                enter_object.setVar('value1', 0)
                enter_object.setVar('value2', 0)
                enter_object.setVar('value3', 0)
                enter_object.setVar('value4', 0)
            end
            if enter_object.getVar('monsterName') == nil then
                enter_object.setVar('monsterName', enter_object.getVar('cardname'))
                enter_object.setVar('monsterDesc', enter_object.getVar('carddesc'))
            end
            getObjectFromGUID('1ba1f5').setValue(enter_object.getVar('value1'))
            getObjectFromGUID('7d7d5f').setValue(enter_object.getVar('value2'))
            getObjectFromGUID('c0a4e4').setValue(enter_object.getVar('value3'))
            getObjectFromGUID('a97acb').setValue(enter_object.getVar('value4'))
            getObjectFromGUID('2e0c03').setName(enter_object.getVar('monsterName'))
            getObjectFromGUID('7db223').setDescription(enter_object.getVar('monsterDesc'))
        end
    end
end

function onObjectLeaveScriptingZone(zone, leave_object)
    if zone.getGUID() == '5b0f80' then
        if leave_object.getVar('cardname') ~= nil then
            callLuaFunctionInOtherScriptWithParams(getObjectFromGUID('c4bc3e'), 'updateMini', {leave_object})

            getObjectFromGUID('1ba1f5').setValue(0)
            getObjectFromGUID('7d7d5f').setValue(0)
            getObjectFromGUID('c0a4e4').setValue(0)
            getObjectFromGUID('a97acb').setValue(0)
            getObjectFromGUID('2e0c03').setName('')
            getObjectFromGUID('2e0c03').setDescription('')
            getObjectFromGUID('7db223').setDescription('')
        end
    end
end

-- MONSTER PLATFORM

function onload()
    self.setTable('pos',{-8,-1.1,0})
    self.setTable('rot',{180,90,0})
    callLuaFunctionInOtherScriptWithParams(Global, 'addButton', {self.getGUID(),7000,800,400,'Update Miniature(s)','forceUpdateMini',self})

    -- Sets the variable to determine what information is sent to the miniatures via button color so as to preserve state across save/laod.
    displayEverything = getObjectFromGUID('ebea77')
    displaySome = getObjectFromGUID('4fb7c1')
    displayNothing = getObjectFromGUID('4bc9ee')
    if displayEverything.getColorTint()[2] == 1 then
        self.setVar('miniDisplay','Everything')
    elseif displaySome.getColorTint()[2] == 1 then
        self.setVar('miniDisplay','Some')
    else
        self.setVar('miniDisplay', 'Nothing')
    end

    -- Sets the counters and cards for use.
    value1Counter = getObjectFromGUID('1ba1f5')
    value2Counter = getObjectFromGUID('7d7d5f')
    value3Counter = getObjectFromGUID('c0a4e4')
    value4Counter = getObjectFromGUID('a97acb')
    nameCard = getObjectFromGUID('2e0c03')
    descCard = getObjectFromGUID('2e0c03')
    activeMiniZone1 = getObjectFromGUID('413e0c') -- The zone in which minis will be updated
end

function forceUpdateMini() -- Finds the card within the scripting zone and sends it as a table to the core updateMini function.
    local parent = {}
    local zoneObjs = getObjectFromGUID('5b0f80').getObjects()
    for i,v in pairs(zoneObjs) do
        if zoneObjs[i].getVar('cardname') ~= nil then
            parent[1] = zoneObjs[i]
        end
    end
    updateMini(parent)
end

function updateMini(parent) -- Takes a monster card and sends its values to be concatenated into the description of its children miniatures.
    parent = parent[1]
    parent.setVar('value1', value1Counter.getValue())
    parent.setVar('value2', value2Counter.getValue())
    parent.setVar('value3', value3Counter.getValue())
    parent.setVar('value4', value4Counter.getValue())
    parent.setVar('monsterName', nameCard.getName())
    parent.setVar('monsterDesc', descCard.getDescription())

    -- Sets values into the card's script to be preserved across saves.
    local tempScript = parent.getLuaScript()
    parent.setLuaScript('--*&\nself.setVar(\"value1\",'..value1Counter.getValue()..')\n'..'self.setVar(\"value2\",'..value2Counter.getValue()..')\n'..'self.setVar(\"value3\",'..value3Counter.getValue()..')\n'..'self.setVar(\"value4\",'..value4Counter.getValue()..')\n'..'self.setVar(\"monsterName\",\"'..parent.getVar('monsterName')..'\")\n'..'self.setVar(\"monsterDesc\",\"'..parent.getVar('monsterDesc')..'\")\n--*&')
    if string.sub(tempScript,1,4) == '--*&' then
        local j = string.find(tempScript,'--*&',5)
        parent.setLuaScript(parent.getLuaScript()..string.sub(tempScript,j+4))
    else
        parent.setLuaScript(parent.getLuaScript()..'\n\n'..tempScript)
    end

    searchForMini(activeMiniZone1.getObjects(), parent)
end

function searchForMini(objTable, parent)  -- Searches the world and sets children miniatures with the correct descriptions based on display setting.
    local parentGUID = parent.getGUID()
    for i,v in pairs(objTable) do
        if objTable[i].getVar('mcardguid') == parentGUID then
            if self.getVar('miniDisplay') == 'Everything' or self.getVar('miniDisplay') == 'Some' then
                objTable[i].setName(parent.getVar('cardname'))
                objTable[i].setDescription(parent.getVar('carddesc'))

                if self.getVar('miniDisplay') == 'Some' then break end

                local tempDesc = objTable[i].getDescription()
                if value1Counter.getName() ~= '' then
                    objTable[i].setDescription(value1Counter.getName()..': '..parent.getVar('value1')..'    ')
                end
                if value2Counter.getName() ~= '' then
                    objTable[i].setDescription(objTable[i].getDescription()..value2Counter.getName()..': '..parent.getVar('value2')..'    ')
                end
                if value3Counter.getName() ~= '' then
                    objTable[i].setDescription(objTable[i].getDescription()..value3Counter.getName()..': '..parent.getVar('value3')..'    ')
                end
                if value4Counter.getName() ~= '' then
                    objTable[i].setDescription(objTable[i].getDescription()..value4Counter.getName()..': '..parent.getVar('value4'))
                end
                objTable[i].setDescription(objTable[i].getDescription()..'\n'..tempDesc)

            else
                objTable[i].setName('')
                objTable[i].setDescription('')
            end
        end
    end
end

function updateMiniDisplay(obj) -- Sets the variable to determine what information is sent to the miniatures.
        if obj.getVar('miniDisplay') == 'Everything' then
            self.setVar('miniDisplay', 'Everything')
            displayEverything.setColorTint({0,1,0})
            displaySome.setColorTint({0,0,0})
            displayNothing.setColorTint({0,0,0})
        elseif obj.getVar('miniDisplay') == 'Some' then
            self.setVar('miniDisplay', 'Some')
            displayEverything.setColorTint({0,0,0})
            displaySome.setColorTint({0,1,0})
            displayNothing.setColorTint({0,0,0})
        else
            self.setVar('miniDisplay', 'Nothing')
            displayEverything.setColorTint({0,0,0})
            displaySome.setColorTint({0,0,0})
            displayNothing.setColorTint({0,1,0})
        end
end

-- BUTTONS

function onload()
    self.setTable('pos',{0,-0.1,-3.1})
    self.setTable('rot',{0,270,0})
    self.setVar('miniDisplay', 'Everything')
    callLuaFunctionInOtherScriptWithParams(Global, 'addButton', {self.getGUID(),2650,500,450,'Display Everything','updateMiniDisplay',getObjectFromGUID('c4bc3e')})
end

function onload()
    self.setTable('pos',{0,-0.1,-3.1})
    self.setTable('rot',{0,270,0})
    self.setVar('miniDisplay', 'Some')
    callLuaFunctionInOtherScriptWithParams(Global, 'addButton', {self.getGUID(),2650,500,450,'Additional Info Only','updateMiniDisplay',getObjectFromGUID('c4bc3e')})
end

function onload()
    self.setTable('pos',{0,-0.1,-3.1})
    self.setTable('rot',{0,270,0})
    self.setVar('miniDisplay', 'Nothing')
    callLuaFunctionInOtherScriptWithParams(Global, 'addButton', {self.getGUID(),2650,500,450,'Display Nothing','updateMiniDisplay',getObjectFromGUID('c4bc3e')})
end
