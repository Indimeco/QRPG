-- GLOBAL

function onObjectEnterScriptingZone(zone, enter_object)
    if zone.getGUID() == '5b0f80' then
        if enter_object.getVar('cardname') ~= nil then
            if enter_object.getVar('value1') == nil then
                enter_object.setVar('value1', 0)
                enter_object.setVar('value2', 0)
            end
            getObjectFromGUID('7d7d5f').setValue(enter_object.getVar('value1'))
            getObjectFromGUID('c0a4e4').setValue(enter_object.getVar('value2'))
            getObjectFromGUID('2e0c03').setName(enter_object.getVar('cardname'))
            getObjectFromGUID('7db223').setDescription(enter_object.getVar('carddesc'))
        end
    end
end

function onObjectLeaveScriptingZone(zone, leave_object)
    if zone.getGUID() == '5b0f80' then
        if leave_object.getVar('cardname') ~= nil then
            callLuaFunctionInOtherScriptWithParams(getObjectFromGUID('c4bc3e'), 'updateMini', {leave_object})

            getObjectFromGUID('7d7d5f').setValue(0)
            getObjectFromGUID('c0a4e4').setValue(0)
            getObjectFromGUID('2e0c03').setName('')
            getObjectFromGUID('7db223').setDescription('')
        end
    end
end

-- MONSTER PLATFORM

function onload()
    self.setTable('pos',{-8,-1.3,0})
    self.setTable('rot',{180,90,0})
    callLuaFunctionInOtherScriptWithParams(Global, 'addButton', {self.getGUID(),7000,800,400,'Update Miniature(s)','forceUpdateMini',self})
end

function forceUpdateMini()
    local parent = {}
    local zoneObjs = getObjectFromGUID('5b0f80').getObjects()
    for i,v in pairs(zoneObjs) do
        if zoneObjs[i].getVar('cardname') ~= nil then
            parent[1] = zoneObjs[i]
        end
    end
    updateMini(parent)
end

function updateMini(parent)
    parent = parent[1]
    parent.setVar('value1', getObjectFromGUID('7d7d5f').getValue())
    parent.setVar('value2', getObjectFromGUID('c0a4e4').getValue())
    parent.setVar('cardname', getObjectFromGUID('2e0c03').getName())
    parent.setVar('carddesc', getObjectFromGUID('7db223').getDescription())

    local parentGUID = parent.getGUID()
    local k = getAllObjects()

    for i,v in pairs(k) do
        if k[i].getVar('mcardguid') == parentGUID then
            k[i].setName(parent.getVar('cardname'))
            k[i].setDescription('AC: '..parent.getVar('value1')..'    HP: '..parent.getVar('value2')..'\n'..parent.getVar('carddesc'))
        end
    end
end
